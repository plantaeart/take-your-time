<!-- Confirmation dialog -->
<p-confirmDialog></p-confirmDialog>

<div class="table-management-container">
  <!-- Header Actions -->
  <div class="table-header">
    <div class="header-left">
      <h3>{{ config().objectName }} Management</h3>
    </div>   
    <div class="header-actions">
      <!-- Global Search -->
      @if (config().search.enabled) {
        <app-global-search
          [placeholder]="config().search.placeholder || 'Search...'"
          [value]="globalFilterValue()"
          [debounceTime]="500"
          [showClearButton]="true"
          size="normal"
          (searchChange)="onGlobalSearchChange($event)"
          (searchClear)="onGlobalSearchClear()">
        </app-global-search>
      }

      <!-- Clear Filters -->
      <p-button 
        icon="pi pi-filter-slash" 
        [text]="true"
        (onClick)="clearFilters()"
        [pTooltip]="clearFiltersTooltip()"
        tooltipPosition="top"
        severity="secondary"
        [disabled]="!hasActiveFilters()">
      </p-button>

      <!-- Add New Item -->
      @if (config().actions.canAdd) {
        <p-button 
          [label]="'Add ' + config().objectName" 
          icon="pi pi-plus" 
          severity="success"
          (onClick)="addNewItem()"
          [disabled]="isCreatingNew()">
        </p-button>
      }

      <!-- Delete Selected -->
      @if (config().actions.canBulkDelete) {
        <p-button 
          label="Delete Selected" 
          icon="pi pi-trash" 
          severity="danger"
          (onClick)="deleteSelectedItems()"
          [disabled]="!hasSelectedItems()">
        </p-button>
      }


    </div>
  </div>

  <!-- Table Container -->
  <div class="table-content">
    <div class="table-grid" [class.loading]="loading()">
      <!-- Main Column Headers -->
      <app-tab-columns-header
        [columns]="visibleColumns()"
        [config]="config()"
        [hierarchyLevel]="0"
        [showSelect]="config().actions.canBulkDelete || false"
        [hierarchyConfig]="hierarchyConfig()"
        [isAllSelected]="isAllSelected()"
        [gridTemplateColumns]="gridTemplateColumns()"
        [data]="data()"
        (sort)="onSort($event)"
        (filterApply)="onFilterApply($event.field, $event.value)"
        (filterClear)="onFilterClear($event)"
        (toggleSelectAll)="toggleSelectAll()">
      </app-tab-columns-header>

    <!-- Table Body -->
    <div class="table-grid-body" [style.--grid-template-columns]="gridTemplateColumns()">
      <!-- New Item Row -->
      @if (isCreatingNew()) {
        <app-row-tab
          [item]="newItem()"
          [columns]="visibleColumns()"
          [config]="getConfigForLevel(0)"
          [isEditing]="true"
          [isNew]="true"
          [showSelect]="config().actions.canBulkDelete || false"
          (save)="saveNewItem($event)"
          (cancel)="cancelNewItem()">
        </app-row-tab>
      }

    <!-- Data Rows -->
    @for (hierarchicalItem of paginatedData(); track getColumnValue(hierarchicalItem.data, {field: config().dataKey})) {
      <!-- Parent Row -->
      <app-row-tab
        [item]="hierarchicalItem.data"
        [columns]="getColumnsForLevel(hierarchicalItem.level)"
        [config]="getConfigForLevel(hierarchicalItem.level)"
        [isEditing]="isEditing(hierarchicalItem.data)"
        [isSelected]="isItemSelected(hierarchicalItem.data)"
        [showSelect]="config().actions.canBulkDelete || false"
        [hierarchyLevel]="hierarchicalItem.level"
        [canExpand]="canExpand(hierarchicalItem)"
        [isExpanded]="hierarchicalItem.expanded || false"
        [isLoadingChildren]="hierarchicalItem.loading || false"
        [hierarchyConfig]="hierarchyConfig()"
        [isCartEmpty]="isCartEmpty(hierarchicalItem)"
        (edit)="startEdit(hierarchicalItem.data)"
        (save)="saveEdit($event)"
        (cancel)="cancelEdit()"
        (delete)="deleteItem(hierarchicalItem.data)"
        (toggleSelect)="toggleSelectItem(hierarchicalItem.data)"
        (toggleExpansion)="toggleExpansion(hierarchicalItem)"
        (customAction)="handleCustomAction($event)">
      </app-row-tab>
      
      <!-- Children Section (when expanded) -->
      @if (hierarchicalItem.expanded && hierarchicalItem.children !== undefined) {
        <!-- Child Level Container with proper grid template -->
        <div [style.--grid-template-columns]="childGridTemplateColumns()">
          <!-- Child Level Header -->
          <app-tab-columns-header
            [columns]="getColumnsForLevel(1)"
            [config]="config()"
            [hierarchyLevel]="1"
            [showSelect]="config().actions.canBulkDelete || false"
            [hierarchyConfig]="hierarchyConfig()"
            [isAllSelected]="false"
            [gridTemplateColumns]="childGridTemplateColumns()"
            [data]="data()"
            (sort)="onSort($event)"
            (filterApply)="onFilterApply($event.field, $event.value)"
            (filterClear)="onFilterClear($event)"
            (toggleSelectAll)="toggleSelectAll()">
          </app-tab-columns-header>
          
          <!-- Add Product Row (when adding cart item for this user) -->
          @if (currentChildAction() && isExecutingChildActionForParent(hierarchicalItem.data)) {
            <app-row-tab
              [item]="newChildDataForDisplay()"
              [columns]="getColumnsForLevel(1)"
              [config]="getConfigForLevel(1)"
              [isEditing]="true"
              [isNew]="true"
              [showSelect]="false"
              [hierarchyLevel]="1"
              [canExpand]="false"
              [hierarchyConfig]="hierarchyConfig()"
              [excludeProductIds]="getExcludeProductIdsForUser(getColumnValue(hierarchicalItem.data, {field: config().dataKey}))"
              (save)="saveNewChildData($event)"
              (cancel)="cancelChildAction()">
            </app-row-tab>
          }
          
          <!-- Child Data Rows -->
          @for (childItem of hierarchicalItem.children; track getColumnValue(childItem.data, {field: config().dataKey})) {
            <app-row-tab
              [item]="childItem.data"
              [columns]="getColumnsForLevel(childItem.level)"
              [config]="getConfigForLevel(childItem.level)"
              [isEditing]="isEditing(childItem.data)"
              [isSelected]="isItemSelected(childItem.data)"
              [showSelect]="config().actions.canBulkDelete || false"
              [hierarchyLevel]="childItem.level"
              [canExpand]="canExpand(childItem)"
              [isExpanded]="childItem.expanded || false"
              [isLoadingChildren]="childItem.loading || false"
              [hierarchyConfig]="hierarchyConfig()"
              [excludeProductIds]="getExcludeProductIdsForUser(getColumnValue(hierarchicalItem.data, {field: config().dataKey}))"
              (edit)="startEdit(childItem.data)"
              (save)="saveEdit($event)"
              (cancel)="cancelEdit()"
              (delete)="deleteItem(childItem.data)"
              (toggleSelect)="toggleSelectItem(childItem.data)"
              (toggleExpansion)="toggleExpansion(childItem)"
              (customAction)="handleCustomAction($event)">
            </app-row-tab>
          }
        </div>
      }
    }

    <!-- Empty State -->
    @if (filteredData().length === 0 && !loading()) {
      <div class="empty-state">
        <i class="pi pi-inbox empty-icon"></i>
        <h4>No {{ config().objectName.toLowerCase() }}s found</h4>
        <p>Start by adding a new {{ config().objectName.toLowerCase() }}</p>
      </div>
    }

    <!-- Loading State -->
    @if (loading()) {
      <div class="loading-state">
        <i class="pi pi-spin pi-spinner loading-icon"></i>
        <p>Loading {{ config().objectName.toLowerCase() }}s...</p>
      </div>
    }
    </div> <!-- table-grid-body -->
    </div> <!-- table-grid -->
  </div> <!-- table-content -->

  <!-- Pagination -->
  @if (config().pagination.enabled) {
    <div class="pagination-container">   
      <p-paginator
        [rows]="rowsPerPage()"
        [totalRecords]="filteredTotalRecords()"
        [first]="(currentPage() - 1) * rowsPerPage()"
        [rowsPerPageOptions]="config().pagination.rowsPerPageOptions"
        [showCurrentPageReport]="config().pagination.showCurrentPageReport || false"
        [currentPageReportTemplate]="config().pagination.currentPageReportTemplate || 'Showing {first} to {last} of {totalRecords} entries'"
        (onPageChange)="onPageChange($event)">
      </p-paginator>
    </div>
  }
</div>
