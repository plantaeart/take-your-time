<div class="product-management">
  <p-table 
    #dt
    [value]="products()" 
    [columns]="cols"
    [loading]="loading()"
    [paginator]="true"
    [rows]="10"
    [totalRecords]="totalRecords()"
    [lazy]="true"
    (onLazyLoad)="loadProductsLazy($event)"
    (onFilter)="onTableFilter($event)"
    [scrollable]="true"
    scrollHeight="600px"
    [(selection)]="selectedProducts"
    dataKey="id"
    [globalFilterFields]="['id', 'name', 'description', 'category', 'inventoryStatus']"
    [filterDelay]="300"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [rowsPerPageOptions]="[10, 20, 50, 100]"
    [exportHeader]="'Product Export'"
    sortMode="single"
    class="product-table">

    <!-- Export Caption -->
    <ng-template pTemplate="caption">
      <div class="table-caption">
        <div class="caption-left">
          <h3>Product Management</h3>
        </div>
        <div class="caption-right header-actions">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input 
              pInputText 
              type="text" 
              [value]="globalFilterValue()"
              (input)="onGlobalFilter($event)"
              placeholder="Search products..." 
              class="global-filter-input" />
          </span>
          <p-button 
            icon="pi pi-filter-slash" 
            [text]="true"
            (onClick)="resetTable()"
            pTooltip="Reset table">
          </p-button>
          <p-button 
            label="Add Product" 
            icon="pi pi-plus" 
            severity="success"
            (onClick)="addNewProduct()"
            [disabled]="isCreatingNew()">
          </p-button>
          <p-button 
            label="Delete Selected" 
            icon="pi pi-trash" 
            severity="danger"
            (onClick)="deleteSelectedProducts()"
            [disabled]="!hasSelectedProducts()">
          </p-button>
          <p-button 
            icon="pi pi-external-link" 
            label="Export CSV" 
            (click)="exportCSV()"
            severity="help"
            [outlined]="true" />
        </div>
      </div>
    </ng-template>
    
    <!-- Table Header -->
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th style="width: 8rem">Actions</th>
        <th pSortableColumn="id" style="width: 8rem">
          <div class="p-column-header-content">
            <span>ID</span>
            <div class="header-icons">
              <p-sortIcon field="id"></p-sortIcon>
              <p-columnFilter type="numeric" field="id" display="menu" [showApplyButton]="true" [showClearButton]="true"></p-columnFilter>
            </div>
          </div>
        </th>
        <th pSortableColumn="name" style="width: 12rem">
          <div class="p-column-header-content">
            <span>Name</span>
            <div class="header-icons">
              <p-sortIcon field="name"></p-sortIcon>
              <p-columnFilter type="text" field="name" display="menu" [showApplyButton]="true" [showClearButton]="true"></p-columnFilter>
            </div>
          </div>
        </th>
        <th style="width: 20rem">
          <div class="p-column-header-content">
            <span>Description</span>
            <p-columnFilter type="text" field="description" display="menu" [showApplyButton]="true" [showClearButton]="true"></p-columnFilter>
          </div>
        </th>
        <th style="width: 10rem">Image</th>
        <th pSortableColumn="category" style="width: 8rem">
          <div class="p-column-header-content">
            <span>Category</span>
            <div class="header-icons">
              <p-sortIcon field="category"></p-sortIcon>
              <p-columnFilter field="category" matchMode="equals" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                  <p-dropdown 
                    [ngModel]="value" 
                    [options]="categoryOptions" 
                    (onChange)="filter($event.value)" 
                    placeholder="Select Category" 
                    [showClear]="true"
                    optionLabel="label" 
                    optionValue="value"
                    appendTo="body">
                    <ng-template pTemplate="selectedItem" let-option>
                      <span>{{ option?.label }}</span>
                    </ng-template>
                    <ng-template pTemplate="item" let-option>
                      <span>{{ option.label }}</span>
                    </ng-template>
                  </p-dropdown>
                </ng-template>
              </p-columnFilter>
            </div>
          </div>
        </th>
        <th pSortableColumn="price" style="width: 6rem">
          <div class="p-column-header-content">
            <span>Price</span>
            <div class="header-icons">
              <p-sortIcon field="price"></p-sortIcon>
              <p-columnFilter type="numeric" field="price" display="menu" currency="USD" [showApplyButton]="true" [showClearButton]="true"></p-columnFilter>
            </div>
          </div>
        </th>
        <th pSortableColumn="quantity" style="width: 6rem">
          <div class="p-column-header-content">
            <span>Quantity</span>
            <div class="header-icons">
              <p-sortIcon field="quantity"></p-sortIcon>
              <p-columnFilter type="numeric" field="quantity" display="menu" [showApplyButton]="true" [showClearButton]="true"></p-columnFilter>
            </div>
          </div>
        </th>
        <th pSortableColumn="inventoryStatus" style="width: 7rem">
          <div class="p-column-header-content">
            <span>Status</span>
            <div class="header-icons">
              <p-sortIcon field="inventoryStatus"></p-sortIcon>
              <p-columnFilter field="inventoryStatus" matchMode="equals" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                  <p-dropdown 
                    [ngModel]="value" 
                    [options]="inventoryStatusOptions" 
                    (onChange)="filter($event.value)" 
                    placeholder="Select Status" 
                    [showClear]="true"
                    optionLabel="label" 
                    optionValue="value"
                    appendTo="body">
                    <ng-template pTemplate="selectedItem" let-option>
                      <span>{{ option?.label }}</span>
                    </ng-template>
                    <ng-template pTemplate="item" let-option>
                      <span>{{ option.label }}</span>
                    </ng-template>
                  </p-dropdown>
                </ng-template>
              </p-columnFilter>
            </div>
          </div>
        </th>
        <th pSortableColumn="rating" style="width: 6rem">
          <div class="p-column-header-content">
            <span>Rating</span>
            <div class="header-icons">
              <p-sortIcon field="rating"></p-sortIcon>
              <p-columnFilter type="numeric" field="rating" display="menu" [showApplyButton]="true" [showClearButton]="true">
                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                  <input 
                    type="number" 
                    pInputText 
                    [ngModel]="value" 
                    (ngModelChange)="filter($event)"
                    placeholder="Enter rating"
                    min="0" 
                    max="5" 
                    step="0.1"
                    class="w-full">
                </ng-template>
              </p-columnFilter>
            </div>
          </div>
        </th>
      </tr>
    </ng-template>

    <!-- New Product Row -->
    @if (isCreatingNew()) {
      <ng-template pTemplate="body" let-rowIndex="rowIndex">
        <tr class="new-product-row">
          <td></td>
          <td>
            <div class="action-buttons">
              <p-button 
                icon="pi pi-check" 
                severity="success"
                size="small"
                [text]="true"
                (onClick)="saveNewProduct()"
                pTooltip="Save">
              </p-button>
              <p-button 
                icon="pi pi-times" 
                severity="secondary"
                size="small"
                [text]="true"
                (onClick)="cancelNewProduct()"
                pTooltip="Cancel">
              </p-button>
            </div>
          </td>
          <td>
            <span class="text-muted">Auto</span>
          </td>
          <td>
            <input 
              type="text"
              pInputText
              placeholder="Product name"
              [(ngModel)]="newProduct().name"
              class="w-full"
              required>
          </td>
          <td>
            <input 
              type="text"
              pInputText
              placeholder="Description"
              [(ngModel)]="newProduct().description"
              class="w-full">
          </td>
          <td>
            <input 
              type="text"
              pInputText
              placeholder="Image URL"
              [(ngModel)]="newProduct().image"
              class="w-full">
          </td>
          <td>
            <p-dropdown
              [options]="categoryOptions"
              [(ngModel)]="newProduct().category"
              optionLabel="label"
              optionValue="value"
              placeholder="Select category"
              class="w-full">
            </p-dropdown>
          </td>
          <td>
            <app-input-number
              [value]="getNewProductPrice()"
              (valueChange)="setNewProductPrice($event)"
              [min]="0"
              [step]="0.01"
              mode="currency"
              currency="USD"
              locale="en-US">
            </app-input-number>
          </td>
          <td>
            <app-input-number
              [value]="getNewProductQuantity()"
              (valueChange)="setNewProductQuantity($event)"
              [min]="0"
              [showButtons]="true">
            </app-input-number>
          </td>
          <td>
            <p-dropdown
              [options]="inventoryStatusOptions"
              [(ngModel)]="newProduct().inventoryStatus"
              optionLabel="label"
              optionValue="value"
              placeholder="Select status"
              class="w-full">
            </p-dropdown>
          </td>
          <td>
            <app-input-number
              [value]="getNewProductRating()"
              (valueChange)="setNewProductRating($event)"
              [min]="0"
              [max]="5"
              [step]="0.1">
            </app-input-number>
          </td>
        </tr>
      </ng-template>
    }

    <!-- Existing Product Rows -->
    <ng-template pTemplate="body" let-product let-rowIndex="rowIndex">
      <tr [class.editing-row]="isEditing(product)">
        <td>
          <p-tableCheckbox [value]="product"></p-tableCheckbox>
        </td>
        <td>
          @if (isEditing(product)) {
            <div class="action-buttons">
              <p-button 
                icon="pi pi-check" 
                severity="success"
                size="small"
                [text]="true"
                (onClick)="saveEdit()"
                pTooltip="Save">
              </p-button>
              <p-button 
                icon="pi pi-times" 
                severity="secondary"
                size="small"
                [text]="true"
                (onClick)="cancelEdit()"
                pTooltip="Cancel">
              </p-button>
            </div>
          } @else {
            <div class="action-buttons">
              <p-button 
                icon="pi pi-pencil" 
                severity="info"
                size="small"
                [text]="true"
                (onClick)="startEdit(product)"
                pTooltip="Edit">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                severity="danger"
                size="small"
                [text]="true"
                (onClick)="deleteProduct(product)"
                pTooltip="Delete">
              </p-button>
            </div>
          }
        </td>
        
        <!-- ID Column -->
        <td>
          <span class="product-id">{{ product.id }}</span>
        </td>
        
        <!-- Data Columns -->
        <td>
          @if (isEditing(product)) {
            <input 
              type="text"
              pInputText
              [(ngModel)]="editingProduct()!.name"
              class="w-full">
          } @else {
            {{ product.name }}
          }
        </td>
        
        <td>
          @if (isEditing(product)) {
            <input 
              type="text"
              pInputText
              [(ngModel)]="editingProduct()!.description"
              class="w-full">
          } @else {
            {{ product.description }}
          }
        </td>
        
        <td>
          @if (isEditing(product)) {
            <input 
              type="text"
              pInputText
              [(ngModel)]="editingProduct()!.image"
              class="w-full">
          } @else {
            @if (product.image) {
              <img [src]="product.image" alt="Product" class="product-thumbnail">
            } @else {
              <span class="text-muted">No image</span>
            }
          }
        </td>
        
        <td>
          @if (isEditing(product)) {
            <p-dropdown
              [options]="categoryOptions"
              [(ngModel)]="editingProduct()!.category"
              optionLabel="label"
              optionValue="value"
              class="w-full">
            </p-dropdown>
          } @else {
            <p-tag 
              [value]="getCategoryLabel(product.category)"
              [severity]="getCategoryColor(product.category)">
            </p-tag>
          }
        </td>
        
        <td>
          @if (isEditing(product)) {
            <app-input-number
              [(value)]="editingProduct()!.price"
              [min]="0"
              [step]="0.01"
              mode="currency"
              currency="USD"
              locale="en-US">
            </app-input-number>
          } @else {
            {{ product.price | currency:'USD':'symbol':'1.2-2' }}
          }
        </td>
        
        <td>
          @if (isEditing(product)) {
            <app-input-number
              [(value)]="editingProduct()!.quantity"
              [min]="0"
              [showButtons]="true">
            </app-input-number>
          } @else {
            {{ product.quantity }}
          }
        </td>
        
        <td>
          @if (isEditing(product)) {
            <p-dropdown
              [options]="inventoryStatusOptions"
              [(ngModel)]="editingProduct()!.inventoryStatus"
              optionLabel="label"
              optionValue="value"
              class="w-full">
            </p-dropdown>
          } @else {
            <span 
              class="status-badge"
              [style.background-color]="getInventoryStatusColor(product.inventoryStatus)"
              [style.color]="'white'">
              {{ getInventoryStatusLabel(product.inventoryStatus) }}
            </span>
          }
        </td>
        
        <td>
          @if (isEditing(product)) {
            <app-input-number
              [value]="getEditingProductRating()"
              (valueChange)="setEditingProductRating($event)"
              [min]="0"
              [max]="5"
              [step]="0.1">
            </app-input-number>
          } @else {
            @if (product.rating) {
              {{ product.rating }} ⭐
            } @else {
              <span class="text-muted">No rating</span>
            }
          }
        </td>
      </tr>
    </ng-template>

    <!-- Empty state -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="11" class="text-center p-4">
          No products found
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>
